name: Docker Build

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      ecr_image_tag:
        description: "Tag for associated docker images"
        value: ${{ jobs.generate_docker_tag.outputs.docker_tag }}

permissions:
  id-token: write
  contents: read

env:
  VAULT_PW: ${{ secrets.VAULT_PW }}
  REPORT_COVERAGE: true
  DPC_CA_CERT: ${{ secrets.DPC_CA_CERT }}
  ENV: "github-ci"

jobs:
  generate_docker_tag:
    runs-on: self-hosted
    outputs:
      docker_tag: ${{ steps.output_docker_tag.outputs.docker_tag }}
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4
        with:
          ref: b6695282032a0de2d9ebb400d2f65faf65f976c2
      - name: "Fetch git info"
        run: |
          git fetch --quiet
      - name: "Get Version Tag"
        id: get-version-tag
        run: |
          set +e
          VERSION_TAG=`git describe --tags --exact-match`
          if [ $? -ne 0 ]; then
            BRANCH_HASH=`git show -s --format='%h'`
            VERSION_TAG="commit_${BRANCH_HASH}"
          fi
          echo $VERSION_TAG
          echo "version_tag=$VERSION_TAG" >> "$GITHUB_OUTPUT"
          set -e
      - name: generate a tag with UTC date and GitHub run_id
        id: output_docker_tag
        run: |
          DOCKER_TAG="rls-${{ steps.get-version-tag.outputs.version_tag }}-$(date -u +'%Y%m%d%H%M')-${{ github.run_id }}"
          echo "$DOCKER_TAG"
          echo "docker_tag=$DOCKER_TAG" >> $GITHUB_OUTPUT

