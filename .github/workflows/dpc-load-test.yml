name: DPC Load Test

on:
  workflow_dispatch:
  push:
    branches:
      - cr/dpc-4401

jobs:
  run-load-test:
    name: "Run DPC API Load Test"
    runs-on: self-hosted
    container:
      image: ubuntu-latest
      options: --user root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start StatsD Integration
        run: |
          docker run -d \
            --name newrelic-statsd \
            --network host \
            -e NR_ACCOUNT_ID=${{ secrets.NEW_RELIC_ACCOUNT_ID }} \
            -e NR_API_KEY=${{ secrets.NEW_RELIC_API_KEY }} \
            -p 8125:8125/udp \
            newrelic/nri-statsd:latest

      - name: Run k6 test
        env:
          LOAD_TEST_CLIENT_TOKEN: ${{ secrets.LOAD_TEST_CLIENT_TOKEN }}
          LOAD_TEST_PRIVATE_KEY: ${{ secrets.LOAD_TEST_PRIVATE_KEY }}
          LOAD_TEST_PUBLIC_KEY_ID: ${{ secrets.LOAD_TEST_PUBLIC_KEY_ID }}
        uses: grafana/run-k6-action@v1
        with:
          path: ./dpc-load-testing/script.js
