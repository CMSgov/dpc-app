name: "DPC CI Workflow"

on:
  push:
    paths-ignore:
      - .github/workflows/opt-out-*
      - lambda/**
  workflow_dispatch: # Allow manual trigger

env:
  VAULT_PW: ${{ secrets.VAULT_PW }}
  REPORT_COVERAGE: true
  DPC_CA_CERT: ${{ secrets.DPC_CA_CERT }}
  ENV: "github-ci"

jobs:
  build-api:
    name: "Build and Test API"
    runs-on: ubuntu-20.04
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v1
      - name: "Set up mvn"
        uses: s4u/setup-maven-action@v1.14.0
        with:
          java-version: 11
      - name: Set env vars from AWS params
        uses: cmsgov/ab2d-bcda-dpc-platform/actions/aws-params-env-action@main
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        with:
          params: |
            SONAR_HOST_URL=/sonarqube/url
            SONAR_TOKEN=/sonarqube/token
      - name: "Sonarqube"
        run: |
          mvn org.sonarsource.scanner.maven:sonar-maven-plugin:3.7.0.1746:sonar -Dsonar.projectKey=bcda-dpc-api -Dsonar.scm.disabled=true -Dsonar.branch.name=${{ github.event.pull_request.head.ref }} -Dsonar.working.directory=./.sonar_workspace -Dsonar.projectVersion=${{ github.event.pull_request.head.sha }}
