<div>
  <% unless cd_invite.errors[:base].empty? %>
    <div class="usa-alert usa-alert--error margin-bottom-4">
      <div class="usa-alert__body">
        <h2 class="usa-alert__heading"><%= cd_invite.errors[:base].first[:status] %></h2>
        <p class="usa-alert__text"><%= cd_invite.errors[:base].first[:text] %></p>
      </div>
    </div>
  <% end %>
  <h1>Invite new user</h1>
  <div class="usa-alert usa-alert--warning margin-bottom-4">
    <div class="usa-alert__body">
      <h2 class="usa-alert__heading">Exact match required</h2>
      <p class="usa-alert__text">
        The name and contact info you enter must be an exact match to the name and contact info your Credential Delegate will provide after receiving this invite.
      </p>
    </div>
  </div>
  <div>
    <h2>Contact Information</h2>
    <%= form_tag organization_credential_delegate_invitations_path(@organization.path_id), method: :post, class: ['usa-form'], id: "cd-form" do %>
      <%= render(Core::Form::TextInputComponent.new(label: 'First or given name',
          attribute: :invited_given_name,
          hint: 'For example, Jose, Darren, or Mai',
          default: cd_invite.invited_given_name,
          error_msg: cd_invite.errors[:invited_given_name]&.first,
          input_options: { maxlength: 25 })) %>
      <%= render(Core::Form::TextInputComponent.new(label: 'Last or family name',
          attribute: :invited_family_name,
          hint: 'For example, Martinez Gonzalez, Gu, or Smith',
          default: cd_invite.invited_family_name,
          error_msg: cd_invite.errors[:invited_family_name]&.first,
          input_options: { maxlength: 25 })) %>
      <%= render(Core::Form::TextInputComponent.new(label: 'Email',
          attribute: :invited_email,
          error_msg: cd_invite.errors[:invited_email]&.first,
          default: cd_invite.invited_email)) %>
      <%= render(Core::Form::TextInputComponent.new(label: 'Confirm email',
          attribute: :invited_email_confirmation,
          error_msg: cd_invite.errors[:invited_email_confirmation]&.first,
          default: cd_invite.invited_email_confirmation)) %>
      <%= link_to 'Go Back', organization_path(organization.path_id), class: ['usa-button', 'usa-button--outline'] %>
      <%= submit_tag('Send invite', class: "usa-button") %>
    <% end %>
    <a id="modal-opener" href="#verify-modal" aria-controls="verify-modal" class="display-none" data-open-modal>Send invite</a>
    <%= render(Core::Modal::ModalComponent.new(
        'Acknowledgement',
        "<p>By assigning this user as a delegate, you are providing them with access to private health information. This means you assume responsibility for their compliance with the Health Insurance Portability and Accountability Act (HIPAA).</p>
        <p>Do you acknowledge your responsibility for your delegate's compliance with HIPAA regulations?</p>
        <p>Upon your acknowledgement they will receive an invitation to sign up for access to the DPC Portal. This invitation will expire in 48 hours.</p>",
        submit_tag("Yes, I acknowledge", class: "usa-button", form: "cd-form", id: 'modal-submitter'),
        'Cancel',
        'verify-modal')) %>
  </div>
</div>

<%= javascript_tag do %>
function verifyNotBlank(formField, errorElementId) {
  var errorElement = document.getElementById(errorElementId);
  if (formField.value.trim()) {
    formField.classList.remove("usa-input--error");
    if (errorElement) {
      errorElement.remove();
    }
    return true;
  } else {
    renderError(formField, errorElementId, "Can't be blank");
    return false;
  }
}

function renderError(formField, errorElementId, errorMsg) {
  var errorElement = document.getElementById(errorElementId);
  if (!errorElement) {
    errorElement = document.createElement("p");
    errorElement.classList.add("usa-error-message");
    errorElement.id = errorElementId;
    formField.insertAdjacentElement("beforebegin", errorElement);
  }
  errorElement.textContent = errorMsg;
  formField.classList.add("usa-input--error");
}

const emailRegex = /[^ ]+@[^ ]+\.[^ ]+/;
function verifyEmail() {
  const errorFieldId = "invited_email_error_msg";
  var valid = verifyNotBlank(email, errorFieldId);
  if (valid && !emailRegex.test(email.value)) {
    valid = false;
    renderError(email, errorFieldId, "Invalid email format");
  }
  return valid;
}

function verifyEmailConfirmation() {
  const errorFieldId = "invited_email_confirmation_error_msg";
  var valid = verifyNotBlank(emailConfirmation, errorFieldId);
  if (valid && emailConfirmation.value != email.value) {
    valid = false;
    renderError(emailConfirmation, errorFieldId, "Email doesn't match");
  }
  if (valid && !emailRegex.test(emailConfirmation.value)) {
    valid = false;
    renderError(emailConfirmation, errorFieldId, "Invalid email format");
  }
  return valid;
}

const givenName  = document.getElementById("invited_given_name");
givenName.addEventListener("blur", () => {
  verifyNotBlank(givenName, "invited_given_name_error_msg");
});

const familyName  = document.getElementById("invited_family_name");
familyName.addEventListener("blur", () => {
  verifyNotBlank(familyName, "invited_family_name_error_msg");
});

const email  = document.getElementById("invited_email");
email.addEventListener("blur", () => {
  verifyEmail();
});

const emailConfirmation  = document.getElementById("invited_email_confirmation");
emailConfirmation.addEventListener("blur", () => {
  verifyEmailConfirmation();
});

document.getElementById("cd-form").addEventListener("submit", (event) => {
  if (event.submitter == document.getElementById("modal-submitter")) {
    return true;
  }

  event.preventDefault();

  var valid = verifyNotBlank(givenName, "invited_given_name_error_msg");
  if (!verifyNotBlank(familyName, "invited_family_name_error_msg")) {
    valid = false;
  }
  if (!verifyEmail()) {
    valid = false;
  }
  if (!verifyEmailConfirmation()) {
    valid = false;
  }

  if (valid) {
    document.getElementById("modal-opener").click();
  }
});
<% end %>
