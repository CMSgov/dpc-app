version: "3"

services:
  migrator:
    build:
      context: dpc-go/dpc-attribution/migrator
      dockerfile: Dockerfile
    depends_on:
      - db
    command: -path=/migrations/ -database postgres://postgres:dpc-safe@db:5432/dpc_attribution_v2?sslmode=disable up
    volumes:
      - ./dpc-go/dpc-attribution/shared_files/decrypted:/app/shared_files/decrypted
      - ./dpc-go/dpc-attribution/migrator/migrations:/migrations
  attribution2:
    image: ${ECR_HOST:-755619740999.dkr.ecr.us-east-1.amazonaws.com/dpc-attribution-go}:latest
    build:
      context: dpc-go/dpc-attribution
      dockerfile: docker/Dockerfiles/Dockerfile.attribution
    depends_on:
      - migrator
    ports:
      - "3001:3001"
    environment:
      - DPC_BFD_CLIENTCERTFILE=/app/shared_files/decrypted/bfd-dev-test-cert.pem
      - DPC_DB_URL=postgresql://postgres:dpc-safe@db:5432/dpc_attribution_v2
      - DPC_DB_URLV1=postgresql://postgres:dpc-safe@db:5432/dpc_attribution
      - DPC_DB_QUEUEURL=postgresql://postgres:dpc-safe@db:5432/dpc_queue
      - DPC_PORT=3001
      - DPC_CA_CERT=-----BEGIN CERTIFICATE-----\nMIIDIDCCAggCCQDYxc6fReJIzDANBgkqhkiG9w0BAQsFADBSMQswCQYDVQQGEwJV\nUzELMAkGA1UECAwCQ0ExEzARBgNVBAcMCkxvc0FuZ2VsZXMxDTALBgNVBAoMBEFD\nTUUxEjAQBgNVBAMMCWxvY2FsaG9zdDAeFw0yMTA4MDMyMDEzMDJaFw0yMjA4MDMy\nMDEzMDJaMFIxCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJDQTETMBEGA1UEBwwKTG9z\nQW5nZWxlczENMAsGA1UECgwEQUNNRTESMBAGA1UEAwwJbG9jYWxob3N0MIIBIjAN\nBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAyylxcIseEtrEjgR5Aca+vOzzCc4b\nOuMLZk5UrrgAb6C/r4aVC3umYNQ3mwbyxhpb505GxtwCgHBGKi30vCP35kjn1rdn\nkpwWbvibSGCrWlPsHAHqAJxmi1c/Z3VQRFxynnvut8/FDv+iYoAuP33t2O8V19ZV\nIG64m6UHV3rHuWTf03wVMHC3MJU1N5Y3B/T+1R4p4ixGiZEHPTRF39DzyC+Vrb4c\nIBIvqww2RNL0qYtjQVaLzwNVhkEqSnXA88SgJwLmaMhwvG3BKFCn9sgWT0hxSF96\n5eomP7zu7AnqmQlQpZRa0Gg/KMHc+Tas37gp/s/MVJH9k63gytoCyzSfXwIDAQAB\nMA0GCSqGSIb3DQEBCwUAA4IBAQAa3YYD+x29LnYeMsglktjirBfi2RRxgbBHzUt9\n/qkwoTD8tgDBqQzxI5xNcD3nXO9B015AFk6zk9MAK/gpJBSZOGPdahxAUr7Hi/ua\ns425NzdG37oGi92ivc/773kxblP+LVs0czC/XIjTLChksUSwdE7U4bdjLfORkjzT\nUNxdRKQxzBpIV/AWFy5VS+AvOh/6Bx3D9YtUZ1FIMiftu/nzmhCA0+3ADR2yULj7\nqLnSiAs+j8zGObKQmXWLtiTr0+h+Tx7eKV6KY+7zB5rRcXlfQd1SFYIpGq7NM4x8\nNeWgLhsv+TV2R5Dt/h0hoDC241CFgFMOlovGOjMMAjyJ1RBL\n-----END CERTIFICATE-----\n
      - DPC_CERT=-----BEGIN CERTIFICATE-----\nMIIDYzCCAkugAwIBAgIJAO9s2CNpDOWgMA0GCSqGSIb3DQEBCwUAMFIxCzAJBgNV\nBAYTAlVTMQswCQYDVQQIDAJDQTETMBEGA1UEBwwKTG9zQW5nZWxlczENMAsGA1UE\nCgwEQUNNRTESMBAGA1UEAwwJbG9jYWxob3N0MB4XDTIxMDgwMzIxMTM1MFoXDTIy\nMDgwMzIxMTM1MFowVzELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkNBMRMwEQYDVQQH\nDApMb3NBbmdlbGVzMRIwEAYDVQQKDAlBQ01FIEF0dHIxEjAQBgNVBAMMCWxvY2Fs\naG9zdDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALH/GoZPHfb2Epqi\nc2QT/AOVai1uKhFUsBUsrrMws/3RHRjLsZEgJsa5UiIhwTW+akgA8Z66BGJXPuUi\nKvh8vJRBiDpmzieUaUnx5A4gAkbHFOg93Izmt9m/Om+pK73OncS9EvI51Ne5sN1W\nOD5JlnRIHpynl8nSwsc9NmHYU28zG4WgWMq1nhakRB9zGcA6uFoE6g6H2VicaCVs\nxd9B11MQ8ly2JjLvFb2yrbGQoZc5K6Qwgg6O1fHqw+279iNv8wYaLChaIyzCMan/\nc7wZuEAkV80LXCt+b+U0PIUpE+vVfyfHR/3z7IHvFbiEelx2+8VpHhy3Xer2dfIw\nNihVj68CAwEAAaM3MDUwMwYDVR0RBCwwKoIJbG9jYWxob3N0gh1sb2NhbC5hdHRy\naWJ1dGlvbi5kcGMuY21zLmdvdjANBgkqhkiG9w0BAQsFAAOCAQEAuA+/RiC/Wca+\nHi8m0tE7sMgoU/a97sNTxqCRXa5ZoqpvIN2D2IODrl+F/F+wkR+FIFV9phTQEuFp\nmCwddSBPpvjt/TtbvxUo9Xa94ydlD+NCEQCfRaLPOmyBGa6fIoOiCNOfXYBdrpJu\ne/9Gabn/rRzL4YP4m0K3hW19JOZuJyZ5cz8ZQaOauh0s6jMwroi5eK+xqpUQCEdW\nEr/C/IMrfoeu7wKhtagSwaqeS4PMb5Rhfq4vq2mzx62h7JtMUWIM1pMscSjU1uOM\nCQDI4e8iiLdoa6mPDN45nuHYLQ01vd4l5msBKm/sOZcKH+tRXyDEPFkX31S1bBD6\nZDeqPqkbhg==\n-----END CERTIFICATE-----\n
      - DPC_CERT_KEY=-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAsf8ahk8d9vYSmqJzZBP8A5VqLW4qEVSwFSyuszCz/dEdGMux\nkSAmxrlSIiHBNb5qSADxnroEYlc+5SIq+Hy8lEGIOmbOJ5RpSfHkDiACRscU6D3c\njOa32b86b6krvc6dxL0S8jnU17mw3VY4PkmWdEgenKeXydLCxz02YdhTbzMbhaBY\nyrWeFqREH3MZwDq4WgTqDofZWJxoJWzF30HXUxDyXLYmMu8VvbKtsZChlzkrpDCC\nDo7V8erD7bv2I2/zBhosKFojLMIxqf9zvBm4QCRXzQtcK35v5TQ8hSkT69V/J8dH\n/fPsge8VuIR6XHb7xWkeHLdd6vZ18jA2KFWPrwIDAQABAoH/bSkGG1hqCArhXfRC\n0B1xcMExXKszIW3Ojy3X9gzoVcDpF0vUmiwdm8ILnOMWmt8sTvxFMhLinWzkJaHO\nuJXHESUfZrGlvKBH8hFmy0LWIpH1QHivybm1BtVAATq+mKkeGIncFLFi1uoKjbNS\nyuBWZPnVzDz72cpnqcjgkSEaChdHP/sL8XvOdZzIzJw5r6Rd7lOdkVpjmkr+Q45x\nt2pE2he+WbTOBaMTmZ/hSLySJhehbFo5ywkIvbWVdXT68pPAP9vQZbwpP8ZSnqXe\nWhSBXols7eKKAA5pKxk7N0KnSvtmsLT27+Tm2AOau6+grfOnmyzJjL4hvHNimIYw\ns29JAoGBAOXHFQtJCSwvf3536F1vgdzsiP7sLhCaOoAwVW0t4FoBbXD9lrXvVs+U\nVE2jhVezVnwh+J/Cf3XR2QBdLQmXAAaJrBYjQbpzpX/DJ+DvUZIGLzLOAmKbkxV2\nqEf+ePJgAYsTWP10pIJdXqoVP3CPPUboqx9jgnWSv9ToYN9wwxYVAoGBAMZPPi6m\nT+kHEnAxf0gPtyPefknhLdQ60xMTLQUWtKwri7TTymVLBv4HnS9JXq8sLg09ww4V\n01NyBDCJ+DIA7fguzI5DytyFCdOAKe++ML0jD5F8FUF+pJGBSHMyuiCk4X82fyjf\n9f7zyMJ4ZrEnl7wa+1Czc2N8xEqKxed4l2OzAoGBAKYW/XMm2+aAftvfuKqxS2Fx\n6KS7+6Asm1TFmzpMCvuERKOD6kigNFPfmAB2zo/SJhWcSKbSZGe5w+2rbD6eU3pm\nUWm/Gme36E0tt8mzs3al2cATgU3dvrepCYLgwnQQSY1J8u1iPvesnhy7NxwZreVv\nkSIjP83Uwa0YO83HKHzxAoGBAI+okC9TI8h36w+Di+U0HUPKxknW6lA4XPgQiCiL\njk67LPXOB2zhsSsNcPz0dbcIlkPZXhgyD2j/y7EuAbKXocyMensE+UxOxBOHYNng\nOYaKg5is/uj3SVhvA4EQWm2ThBeX7v45YAdVqzXV6u6i8/S8xxprJUgI9lnZtgw8\n+86pAoGBAOCcht2F//eMnM9DGzVOInH//Ch2AsEU5tqXTyUf3DSdKyT5wSH+M2+p\n9mbwcUuZ+C9eAAzYJWbUGUSBRffAeqXcFUxy8rrmPRDSPjUA8mpNG/wsJVyRQaXP\njWtL9SxIOjw0LNTC5H41WbSlIl182990W0XpTx5tLWBcYlWD2oeF\n-----END RSA PRIVATE KEY-----\n
    volumes:
      - ./dpc-go/dpc-attribution/shared_files/decrypted:/app/shared_files/decrypted
